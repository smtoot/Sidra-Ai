generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User & Auth
enum UserRole {
  PARENT
  TEACHER
  ADMIN
  SUPPORT
}

enum Gender {
  MALE
  FEMALE
}

enum KYCStatus {
  PENDING
  INFO_REQUIRED
  INTERVIEW_SCHEDULED
  APPROVED
  REJECTED
}

enum CancellationPolicy {
  FLEXIBLE
  MODERATE
  STRICT
}

enum DocumentType {
  ID_CARD
  CERTIFICATE
  DEGREE
  OTHER
}

// Days of week
enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  role          UserRole
  phoneNumber   String?
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  parentProfile   ParentProfile?
  teacherProfile  TeacherProfile?
  auditLogs       AuditLog[]

  @@map("users")
}

model ParentProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  
  // Children
  students  Student[]

  @@map("parent_profiles")
}

model TeacherProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  displayName       String?
  bio               String?
  yearsOfExperience Int?
  education         String?
  gender            Gender?
  
  // KYC
  kycStatus          KYCStatus @default(PENDING)
  kycRejectionReason String?
  
  // Onboarding
  hasCompletedOnboarding Boolean @default(false)
  onboardingStep         Int     @default(0)
  
  // Settings
  cancellationPolicy CancellationPolicy @default(FLEXIBLE)
  
  // Secure Data
  encryptedMeetingLink String?

  // Stats (Denormalized)
  averageRating Float @default(0)
  totalReviews  Int   @default(0)
  totalSessions Int   @default(0)
  
  // Relations
  subjects    TeacherSubject[]
  availability Availability[]
  documents   Document[]
  bankInfo    BankInfo?
  
  @@map("teacher_profiles")
}

model Student {
  id              String         @id @default(uuid())
  parentId        String
  parent          ParentProfile  @relation(fields: [parentId], references: [id])
  name            String
  gradeLevel      String?
  
  @@map("students")
}

// Dynamic Data (No Enums for Content)
model Curriculum {
  id        String    @id @default(uuid())
  nameAr    String
  nameEn    String
  isActive  Boolean   @default(true)
  
  subjects        CurriculumSubject[]
  teacherSubjects TeacherSubject[]

  @@map("curricula")
}

model Subject {
  id        String    @id @default(uuid())
  nameAr    String
  nameEn    String
  isActive  Boolean   @default(true)
  
  curricula       CurriculumSubject[]
  teacherSubjects TeacherSubject[]

  @@map("subjects")
}

model CurriculumSubject {
  curriculumId String
  subjectId    String
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])
  subject      Subject    @relation(fields: [subjectId], references: [id])

  @@id([curriculumId, subjectId])
  @@map("curriculum_subjects")
}

model TeacherSubject {
  id              String         @id @default(uuid())
  teacherId       String
  teacherProfile  TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  subjectId       String
  subject         Subject        @relation(fields: [subjectId], references: [id])
  curriculumId    String
  curriculum      Curriculum     @relation(fields: [curriculumId], references: [id])
  
  pricePerHour    Decimal        @db.Decimal(10, 2)
  gradeLevels     String[]       // Array of strings for simplicity in Phase 1
  
  @@map("teacher_subjects")
}

model Availability {
  id              String         @id @default(uuid())
  teacherId       String
  teacherProfile  TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  dayOfWeek       DayOfWeek
  startTime       String         // "09:00"
  endTime         String         // "17:00"
  isRecurring     Boolean        @default(true)
  
  @@map("availability")
}

model Document {
  id              String         @id @default(uuid())
  teacherId       String
  teacherProfile  TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  type            DocumentType
  fileName        String
  fileUrl         String
  uploadedAt      DateTime       @default(now())
  
  @@map("documents")
}

model BankInfo {
  id                String         @id @default(uuid())
  teacherId         String         @unique
  teacherProfile    TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  bankName          String
  accountNumber     String
  accountHolderName String
  iban              String?
  swiftCode         String?
  
  @@map("bank_info")
}

// System
model AuditLog {
  id        String   @id @default(uuid())
  action    String   // e.g., "PAYMENT_REJECTED", "USER_BANNED"
  payload   Json?
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])
  targetId  String?  // ID of the object being acted upon
  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@map("audit_logs")
}
