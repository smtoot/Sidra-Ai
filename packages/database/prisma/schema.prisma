generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  passwordHash   String
  role           UserRole
  phoneNumber    String?
  isActive       Boolean         @default(true)
  isVerified     Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  auditLogs      AuditLog[]
  parentProfile  ParentProfile?
  teacherProfile TeacherProfile?
  wallet         Wallet?

  @@map("users")
}

model ParentProfile {
  id       String    @id @default(uuid())
  userId   String    @unique
  bookings Booking[]
  user     User      @relation(fields: [userId], references: [id])
  students Student[]

  @@map("parent_profiles")
}

model TeacherProfile {
  id                     String             @id @default(uuid())
  userId                 String             @unique
  bio                    String?
  averageRating          Float              @default(0)
  cancellationPolicy     CancellationPolicy @default(FLEXIBLE)
  education              String?
  encryptedMeetingLink   String?
  gender                 Gender?
  hasCompletedOnboarding Boolean            @default(false)
  kycRejectionReason     String?
  kycStatus              KYCStatus          @default(PENDING)
  onboardingStep         Int                @default(0)
  totalReviews           Int                @default(0)
  totalSessions          Int                @default(0)
  yearsOfExperience      Int?
  displayName            String?
  availability           Availability[]
  bankInfo               BankInfo?
  bookings               Booking[]
  documents              Document[]
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  subjects               TeacherSubject[]

  @@map("teacher_profiles")
}

model Student {
  id         String        @id @default(uuid())
  parentId   String
  name       String
  gradeLevel String?
  bookings   Booking[]
  parent     ParentProfile @relation(fields: [parentId], references: [id])

  @@map("students")
}

model Curriculum {
  id              String              @id @default(uuid())
  nameAr          String
  nameEn          String
  isActive        Boolean             @default(true)
  subjects        CurriculumSubject[]
  teacherSubjects TeacherSubject[]

  @@map("curricula")
}

model Subject {
  id              String              @id @default(uuid())
  nameAr          String
  nameEn          String
  isActive        Boolean             @default(true)
  curricula       CurriculumSubject[]
  teacherSubjects TeacherSubject[]

  @@map("subjects")
}

model CurriculumSubject {
  curriculumId String
  subjectId    String
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id])
  subject      Subject    @relation(fields: [subjectId], references: [id])

  @@id([curriculumId, subjectId])
  @@map("curriculum_subjects")
}

model TeacherSubject {
  id             String         @id @default(uuid())
  teacherId      String
  subjectId      String
  curriculumId   String
  pricePerHour   Decimal        @db.Decimal(10, 2)
  gradeLevels    String[]
  curriculum     Curriculum     @relation(fields: [curriculumId], references: [id])
  subject        Subject        @relation(fields: [subjectId], references: [id])
  teacherProfile TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("teacher_subjects")
}

model Availability {
  id             String         @id @default(uuid())
  teacherId      String
  dayOfWeek      DayOfWeek
  startTime      String
  endTime        String
  isRecurring    Boolean        @default(true)
  teacherProfile TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("availability")
}

model Document {
  id             String         @id @default(uuid())
  teacherId      String
  type           DocumentType
  fileName       String
  fileUrl        String
  uploadedAt     DateTime       @default(now())
  teacherProfile TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model BankInfo {
  id                String         @id @default(uuid())
  teacherId         String         @unique
  bankName          String
  accountNumber     String
  accountHolderName String
  iban              String?
  swiftCode         String?
  teacherProfile    TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("bank_info")
}

model Wallet {
  id             String        @id @default(uuid())
  userId         String        @unique
  balance        Decimal       @default(0) @db.Decimal(10, 2)
  pendingBalance Decimal       @default(0) @db.Decimal(10, 2)
  currency       String        @default("SDG")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  transactions   Transaction[]
  user           User          @relation(fields: [userId], references: [id])

  @@map("wallets")
}

model Transaction {
  id             String            @id @default(uuid())
  walletId       String
  amount         Decimal           @db.Decimal(10, 2)
  type           TransactionType
  status         TransactionStatus @default(PENDING)
  referenceImage String?
  adminNote      String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  wallet         Wallet            @relation(fields: [walletId], references: [id])

  @@map("transactions")
}

model Booking {
  id             String         @id @default(uuid())
  teacherId      String
  parentId       String
  studentId      String
  subjectId      String
  startTime      DateTime
  endTime        DateTime
  meetingLink    String?
  price          Decimal        @db.Decimal(10, 2)
  commissionRate Decimal        @default(0.18) @db.Decimal(5, 2)
  status         BookingStatus  @default(PENDING_TEACHER_APPROVAL)
  cancelReason   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  parentProfile  ParentProfile  @relation(fields: [parentId], references: [id])
  student        Student        @relation(fields: [studentId], references: [id])
  teacherProfile TeacherProfile @relation(fields: [teacherId], references: [id])

  @@map("bookings")
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  payload   Json?
  actorId   String
  targetId  String?
  createdAt DateTime @default(now())
  actor     User     @relation(fields: [actorId], references: [id])

  @@index([actorId])
  @@index([action])
  @@map("audit_logs")
}

enum UserRole {
  PARENT
  TEACHER
  ADMIN
  SUPPORT
}

enum Gender {
  MALE
  FEMALE
}

enum KYCStatus {
  PENDING
  INFO_REQUIRED
  INTERVIEW_SCHEDULED
  APPROVED
  REJECTED
}

enum CancellationPolicy {
  FLEXIBLE
  MODERATE
  STRICT
}

enum DocumentType {
  ID_CARD
  CERTIFICATE
  DEGREE
  OTHER
}

enum DayOfWeek {
  SUNDAY
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT_LOCK
  PAYMENT_RELEASE
  REFUND
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING_TEACHER_APPROVAL
  WAITING_FOR_PAYMENT
  PAYMENT_REVIEW
  SCHEDULED
  COMPLETED
  REJECTED_BY_TEACHER
  CANCELLED_BY_PARENT
  CANCELLED_BY_ADMIN
  EXPIRED
}
